---
title: "Analysis of repeats identified in target PacBio contigs using LASTZ"
output: html_document
---
```{r setup, echo=FALSE}
knitr::opts_knit$set(root.dir = '../EXPERIMENTS/5_PacBio_LASTZ')
knitr::opts_chunk$set(warning=FALSE,error=FALSE,message=FALSE)
```
```{r, echo=FALSE}
require(ggplot2)
require(RColorBrewer)
data <- read.csv("q_contig6TRF_PacBio.forR.csv", sep="\t", header=TRUE)
```

Number of repeats identified by each query
```{r, echo=FALSE}
sapply(split(data$length1, data$name2), length)
```

Median length of repeats identified by each query
```{r, echo=FALSE}
sapply(split(data$length1, data$name2), median)
```

```{r, echo=FALSE}
q <- ggplot(data, aes(x=name2, y=length1)) + geom_boxplot(trim=FALSE) 
q <- q + theme_minimal() + labs(title="Length of repeats identified by query", x="", y="")
q <- q + guides(fill=FALSE) 
q <- q + theme(axis.text=element_text(size=12, face="bold"))
q
```

```{r, echo=FALSE}
p <- ggplot(data, aes(x=name2, y=idPct, fill=name2)) + geom_violin(trim=FALSE) 
p <- p + stat_summary(fun.y=mean, geom="point", shape=3, size=3)
p <- p + theme_minimal() + labs(title="% identity of repeats by query", x="", y="")
p <- p + guides(fill=FALSE) 
p <- p + scale_fill_manual(values=rev(brewer.pal(6,"Blues")))
p <- p + theme(axis.text=element_text(size=12, face="bold"))
p
```

Table summarizes base pairs between "tandem" repeats identified by each query
```{r, echo=FALSE}
spacing <- read.csv("q_contig6TRF_PacBio.spacing.csv", header=FALSE, sep= "\t")
sapply(split(spacing$V3,spacing$V2),summary)
```

```{r, echo=FALSE}
r <- ggplot(spacing, aes(x=V3, fill=V2)) + xlim(-5,15) + geom_density()
r <- r + facet_grid(V2~., scales="free_y")
r <- r + theme_minimal() + labs(title="Base pairs between adjacent repeats by query", x="", y="")
r <- r + guides(fill=FALSE) 
r <- r + scale_fill_manual(values=rev(brewer.pal(6,"Blues")))
r <- r + theme(strip.text=element_text(size=12), strip.background = element_rect(fill="grey",size=1))
r <- r + theme(axis.text=element_text(size=10, face="bold"))
r
```

From the above analysis it appears that all 6 query sequences identify approximately the same number of repeats. However, CEN1 and CEN6 do the worst in terms of the "tandem" nature of the repeats. In an ideal world adjacent repeats should have 0 base pairs seperating them. Given that **CEN2** identified the maximum number of repeats and the median seperation between adjacent repeats is 2 bp I am choosing to move forward with that as the sole query sequence.

## CEN2 as query

```{r, echo=FALSE}
library(dplyr)
dCEN2 <- filter(data, name2 == "CEN2")
dCEN2$name1 <- as.factor(dCEN2$name1)
```

Histogram of length of repeats identified by CEN2
```{r, echo=FALSE}
s <- ggplot(dCEN2, aes(length1)) + geom_histogram(binwidth=1)
s <- s + scale_x_continuous(name="Repeat Lengths", limits=c(100,250), breaks=c(seq(100,250,by=25)))
s <- s + theme_minimal()
s
```

Histogram of % identity of target sequences to CEN2
```{r, echo=FALSE}
t <- ggplot(dCEN2, aes(idPct)) + geom_histogram(binwidth=1)
t <- t + scale_x_continuous(name="% Identity of repeats to CEN2", limits=c(70,100), breaks=c(seq(70,100,by=5)))
t <- t + theme_minimal()
t
```

To generate a reliable multiple sequence alignment from these repeats I want to discard sequences that have too many gaps inserted by LASTZ to get a hit. In this case it is 14 
```{r, echo=FALSE}
gaps <- read.csv("q_contig6TRF_PacBio.gaps.csv", header=FALSE, sep= "\t")
gapsCEN2 <- gaps[gaps$V2 =="CEN2",]
gdf <- data.frame(table(gapsCEN2$V3))
u <- ggplot(gdf, aes(x=Var1,y=Freq)) + geom_histogram(stat="identity")
u <- u + scale_y_log10() + theme_bw() 
u <- u + xlab("No. of gaps in target") +ylab("Counts on a log scale")
u <- u + theme(axis.text=element_text(size=14, face="bold"), axis.title=element_text(size=18))
u <- u + geom_vline(xintercept=14, colour="red", size=0.75)
u <- u + scale_x_discrete(breaks=seq(0,100,2))
u
```

Summary table of repeats identified by CEN2 in PacBio contigs
```{r, echo=FALSE}
data2 <- select(dCEN2, name1, size1, strand2, idPct, length1)
data2 <- data2 %>% group_by(name1) %>% mutate(rep_fraction = (sum(length1)/size1)*100)
data2 <- data2 %>% group_by(name1) %>% mutate(no_of_repeats = n())
data2 <- data2 %>% group_by(name1) %>% mutate(med_length = median(length1)*1.0)
data2 <- data2 %>% group_by(name1) %>% mutate(range_length = paste(min(length1),max(length1),sep="-"))
data2 <- data2 %>% group_by(name1) %>% mutate(range_idPct = paste(min(idPct),max(idPct),sep="-"))
data2 <- data2 %>% group_by(name1) %>% mutate(strand = n_distinct(strand2))
data2 <- select(data2, name1, no_of_repeats, rep_fraction, med_length, range_length, range_idPct, strand)
data2 <- distinct(data2)
data2 <- ungroup(data2)
data2 <- arrange(data2,desc(no_of_repeats))
library(knitr)
kable(data2)
```
